<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://aethernet65535.github.io name=base><title>
            
                XV6-2020 LAB9-FILESYSTEM
            
        </title><meta content="XV6-2020 LAB9-FILESYSTEM" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://aethernet65535.github.io/fonts.css rel=stylesheet><script src=https://aethernet65535.github.io/js/codeblock.js></script><script src=https://aethernet65535.github.io/js/toc.js></script><script src=https://aethernet65535.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://aethernet65535.github.io/atom.xml rel=alternate title=aethernet-blog type=application/atom+xml><link href=https://aethernet65535.github.io/theme/light.css rel=stylesheet><link href=https://aethernet65535.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://aethernet65535.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://aethernet65535.github.io/main.css media=screen rel=stylesheet><script src="https://aethernet65535.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://aethernet65535.github.io>aethernet-blog</a><div class=socials><a class=social href=https://twitter.com/not_matthias rel=me> <img alt=twitter src=https://aethernet65535.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/not-matthias/ rel=me> <img alt=github src=https://aethernet65535.github.io/icons/social/github.svg> </a></div></div><nav><a href=https://aethernet65535.github.io/posts style=margin-left:.25em>/posts</a><a href=https://aethernet65535.github.io/projects style=margin-left:.25em>/projects</a><a href=https://aethernet65535.github.io/about style=margin-left:.25em>/about</a><a href=https://aethernet65535.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://aethernet65535.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://aethernet65535.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://aethernet65535.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>XV6-2020 LAB9-FILESYSTEM<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-07-21</time> :: 1946 Words <span class=tags-label>:: Tags:</span><span class=tags> <a class=post-tag href=https://aethernet65535.github.io/tags/xv6/>xv6</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#qian-yan>前言</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#large-files-moderate>large files (moderate)</a> <ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-inodejie-gou>修改inode结构</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-bmaphan-shu>修改bmap函数</a></li><ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-qian>修改前</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-hou>修改后</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-itrunchan-shu>修改itrunc函数</a></li><ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-qian-1>修改前</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiu-gai-hou-1>修改后</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiao-xiu-xiao-bu>小修小补</a></li><ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#1-he-xin-gai-nian-jie-shi>1. 核心概念解释</a></ul></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#symbolic-links-moderate>symbolic links (moderate)</a> <ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#ji-chu-gai-nian-ying-lian-jie-yu-ruan-lian-jie-de-qu-bie>基础概念：硬链接与软链接的区别</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#shi-xian>实现</a></li><ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xi-tong-diao-yong>系统调用</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#wen-jian-lei-xing-biao-qian>文件类型（标签）</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#chuang-jian-ruan-lian-jie-wen-jian>创建软链接文件</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#da-kai-wen-jian>打开文件</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#xiao-zhi-shi>小知识</a></li><ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#posixbiao-zhun-de-o-nofollow>POSIX标准的O_NOFOLLOW</a></ul></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab9-fs/#wan-jie-sa-hua-o-e-o>完结撒花 (　o=^•ェ•)o　┏━┓</a></ul></div><section class=body><h1 id=qian-yan><a aria-label="Anchor link for: qian-yan" class=zola-anchor href=#qian-yan>前言</a></h1><p>这个lab能学到的东西还挺多的，算是一个很好的文件系统入门了。<h1 id=large-files-moderate><a aria-label="Anchor link for: large-files-moderate" class=zola-anchor href=#large-files-moderate>large files (moderate)</a></h1><p>第一个小作业是要给xv6现有的fs添加一个二级索引，我们先说说原本的是怎么样的吧。<blockquote><p>[0 - 11] 直接索引 | [12] 一级索引 然后我们要改成这样：<br> [0 - 10] 直接索引 | [11] 一级索引 | [12] 二级索引</blockquote><p>直接索引：<ul><li>存储指向块的地址<li>能直接找到数据，不需要在跳转</ul><p>一级索引：<ul><li>存储地址，指向一个**「索引块」**<li>索引块里有<strong>256个</strong>数据块地址</ul><p>二级索引：<ul><li>存储地址，指向一个**「集合块」**<li>集合块存储着<strong>256个「一级索引块」</strong><li>每个一级索引块能存储<strong>256个</strong>数据块地址<li>所以一个二级索引最多能存储<strong>256×256个</strong>块，也就是<strong>65536个</strong></ul><p>差不多是这样：<blockquote><p>一级索引 -> 256个块地址<br> 二级索引 -> 256个一级索引地址 -> (256*256)个块地址</blockquote><p>如果算总空间的话...一开始是256+12，也就是268×1024，274,432B、<strong>268kB</strong>，说实话好像有点小。<br> 现在的话，是(11)+(256)+(256×256)，也就是65,804kB、<strong>64mB</strong>，那确实挺多的了。<p>声明：如果在其他地方看到了其他术语，那就默认博主（我）的是错的，因为这些术语我没怎么查过，临时自创的。<h2 id=xiu-gai-inodejie-gou><a aria-label="Anchor link for: xiu-gai-inodejie-gou" class=zola-anchor href=#xiu-gai-inodejie-gou>修改inode结构</a></h2><p>根据xv6的提示，我们需要把<code>NDIRECT</code>改为<strong>11</strong>，因为之前的其中一个要用来放<strong>二级索引</strong>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>#define </span><span style=color:#399ee6>NDIRECT </span><span style=color:#ff8f40>11 </span><span style=color:#abb0b6;font-style:italic>// 直接块
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>DINDIRECT </span><span>(NDIRECT </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>1</span><span>) </span><span style=color:#abb0b6;font-style:italic>// 二级索引
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>NINDIRECT </span><span>(BSIZE </span><span style=color:#ed9366>/ </span><span style=color:#fa6e32>sizeof</span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span>)) </span><span style=color:#abb0b6;font-style:italic>// 一级索引能存的地址量
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>MAXFILE </span><span>(NDIRECT </span><span style=color:#ed9366>+</span><span> NINDIRECT </span><span style=color:#ed9366>+ </span><span>(NINDIRECT </span><span style=color:#ed9366>*</span><span> NINDIRECT)) </span><span style=color:#abb0b6;font-style:italic>// 一个进程最多能持有的文件缓存块数
</span></code></pre><p>然后<code>inode</code>结构体的<code>addrs</code>字段就要改为<strong>直接块（0-10）、一级索引（11）、二级索引（12）</strong>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>struct </span><span style=color:#399ee6>dinode </span><span>{
</span><span>  </span><span style=color:#fa6e32>short</span><span> type</span><span style=color:#61676ccc>;               </span><span style=color:#abb0b6;font-style:italic>// File type
</span><span>  </span><span style=color:#fa6e32>short</span><span> major</span><span style=color:#61676ccc>;              </span><span style=color:#abb0b6;font-style:italic>// Major device number (T_DEVICE only)
</span><span>  </span><span style=color:#fa6e32>short</span><span> minor</span><span style=color:#61676ccc>;              </span><span style=color:#abb0b6;font-style:italic>// Minor device number (T_DEVICE only)
</span><span>  </span><span style=color:#fa6e32>short</span><span> nlink</span><span style=color:#61676ccc>;              </span><span style=color:#abb0b6;font-style:italic>// Number of links to inode in file system
</span><span>  </span><span style=color:#55b4d4;font-style:italic>uint</span><span> size</span><span style=color:#61676ccc>;                </span><span style=color:#abb0b6;font-style:italic>// Size of file (bytes)
</span><span>  </span><span style=color:#55b4d4;font-style:italic>uint</span><span> addrs[NDIRECT</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>2</span><span>]</span><span style=color:#61676ccc>;    </span><span style=color:#abb0b6;font-style:italic>// Data block addresses
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h2 id=xiu-gai-bmaphan-shu><a aria-label="Anchor link for: xiu-gai-bmaphan-shu" class=zola-anchor href=#xiu-gai-bmaphan-shu>修改bmap函数</a></h2><p>这个函数的作用是：<br> 返回：在实参inode结构体中，对应块号的地址<br> 如果没有这个块号的地址，那就创建一个。<h3 id=xiu-gai-qian><a aria-label="Anchor link for: xiu-gai-qian" class=zola-anchor href=#xiu-gai-qian>修改前</a></h3><p>这个函数有点难，所以我们慢慢看。<br> 首先，第一段：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// 直接块处理方法
</span><span style=color:#fa6e32>if</span><span>(bn </span><span style=color:#ed9366>&lt;</span><span> NDIRECT){ 
</span><span>    </span><span style=color:#fa6e32>if</span><span>((addr </span><span style=color:#ed9366>=</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[bn]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>) 
</span><span>      ip</span><span style=color:#ed9366>-></span><span>addrs[bn] </span><span style=color:#ed9366>=</span><span> addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;  
</span><span>    </span><span style=color:#fa6e32>return</span><span> addr</span><span style=color:#61676ccc>;
</span><span>  }
</span></code></pre><p>代码作用：<ol><li>如果bn下标还没被占用，那就分配一个空闲块号。<li>如果里面已经有地址了，那直接赋值给addr，然后这函数基本就完工了。</ol><p>其次，第二段：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// 这个很重要的，注意
</span><span style=color:#abb0b6;font-style:italic>// 没有这个的话那你块号是255之类的就完啦！
</span><span style=color:#abb0b6;font-style:italic>// 或者其他合法但是在这里过大的索引
</span><span style=color:#abb0b6;font-style:italic>// 不是错位就是爆炸！
</span><span>bn </span><span style=color:#ed9366>-=</span><span> NDIRECT</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 一级索引处理方法
</span><span style=color:#fa6e32>if</span><span>(bn </span><span style=color:#ed9366>&lt;</span><span> NINDIRECT){
</span><span>    </span><span style=color:#fa6e32>if</span><span>((addr </span><span style=color:#ed9366>=</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>      ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT] </span><span style=color:#ed9366>=</span><span> addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;
</span><span>    bp </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> addr)</span><span style=color:#61676ccc>;
</span><span>    a </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>((addr </span><span style=color:#ed9366>=</span><span> a[bn]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      a[bn] </span><span style=color:#ed9366>=</span><span> addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>log_write</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f29718>brelse</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return</span><span> addr</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"bmap: out of range"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>代码作用：<ol><li>如果索引块还没创建，那就分配一个索引块<li>获取该数据块的缓存<li>对该缓存块的<code>data</code>字段进行类型转换并赋值给<code>a</code></ol><blockquote><p><code>uchar data[1024]</code>在转换后，就会变成<code>uint*[256]</code>了<br> 你可能会疑惑“啊？为什么不是<strong>128</strong>呢？<strong>1024/8</strong>是<strong>128</strong>呀！<br> 但是其实这里是用<code>uint</code>本身的大小转换的呢，很神奇吧，就是<strong>4字节</strong>！<br> 反正就是这样，明白不是用指针大小转换就行了！</blockquote><ol start=4><li>如果在这个256个地址的索引块数组内没有对应bn的地址，那就分配一块空闲的</ol><blockquote><p>然后这里还要调用<code>log_write()</code>，具体原因博主不是很清楚， 似乎是因为索引块并不是直接属于inode的，所以就得调用<br> 别忘了调用<code>brelse()</code>释放锁，因为<code>bread()</code>会调用<code>bget()</code>，这过程会让对应的块缓存被锁， 所以一定得释放锁，毕竟我们已经好了</blockquote><ol start=5><li>如果啥事没有的话，就直接给用户返回addr</ol><h3 id=xiu-gai-hou><a aria-label="Anchor link for: xiu-gai-hou" class=zola-anchor href=#xiu-gai-hou>修改后</a></h3><p>基本照葫芦画瓢就可以做出一个<strong>二级索引VER</strong>了呢！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>bn </span><span style=color:#ed9366>-=</span><span> NINDIRECT</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if</span><span>(bn </span><span style=color:#ed9366>&lt;</span><span> NINDIRECT </span><span style=color:#ed9366>*</span><span> NINDIRECT){ </span><span style=color:#abb0b6;font-style:italic>// 只要在65535范围内的就都是合法bn
</span><span>  dbn </span><span style=color:#ed9366>=</span><span> bn </span><span style=color:#ed9366>/</span><span> NINDIRECT</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 在哪个一级索引块？
</span><span>  dbnoff </span><span style=color:#ed9366>=</span><span> bn </span><span style=color:#ed9366>%</span><span> NINDIRECT</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 在该块的第几个索引？
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>((addr </span><span style=color:#ed9366>=</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>    ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT] </span><span style=color:#ed9366>=</span><span> addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 和刚刚的一样，不过读者可以把它想得更简单点
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 想成“进入该块”就可以了，这次我们进入的是集合块
</span><span>  bp </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> addr)</span><span style=color:#61676ccc>;
</span><span>  a </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>    
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 在集合块内有没有对应的一级索引块？
</span><span>  </span><span style=color:#fa6e32>if</span><span>((addr2 </span><span style=color:#ed9366>=</span><span> a[dbn]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    a[dbn] </span><span style=color:#ed9366>=</span><span> addr2 </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>log_write</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#f29718>brelse</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 这次进入的是对应的一级索引块
</span><span>  bp2 </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> addr2)</span><span style=color:#61676ccc>;
</span><span>  a2 </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp2</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 在该一级索引块有没有对应bn的块号？
</span><span>  </span><span style=color:#fa6e32>if</span><span>((addr </span><span style=color:#ed9366>=</span><span> a2[dbnoff]) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    a2[dbnoff] </span><span style=color:#ed9366>=</span><span> addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>balloc</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>log_write</span><span>(bp2)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#f29718>brelse</span><span>(bp2)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>return</span><span> addr</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=xiu-gai-itrunchan-shu><a aria-label="Anchor link for: xiu-gai-itrunchan-shu" class=zola-anchor href=#xiu-gai-itrunchan-shu>修改itrunc函数</a></h2><p>这个函数的作用是：<h3 id=xiu-gai-qian-1><a aria-label="Anchor link for: xiu-gai-qian-1" class=zola-anchor href=#xiu-gai-qian-1>修改前</a></h3><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// 直接块处理方法（遍历直接块）
</span><span style=color:#fa6e32>for</span><span>(i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>&lt;</span><span> NDIRECT</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){
</span><span>  </span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>addrs[i]){
</span><span>    </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[i])</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 如果存在映射，那就释放被映射的缓存块
</span><span>    ip</span><span style=color:#ed9366>-></span><span>addrs[i] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 然后取消映射
</span><span>  }
</span><span>}
</span></code></pre><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// 一级索引块处理方法（也差不多是遍历）
</span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT]){ 
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 进入块，进入的是一级索引块
</span><span>  bp </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT])</span><span style=color:#61676ccc>;
</span><span>  a </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 遍历一级索引快
</span><span>  </span><span style=color:#fa6e32>for</span><span>(j </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> j </span><span style=color:#ed9366>&lt;</span><span> NINDIRECT</span><span style=color:#61676ccc>;</span><span> j</span><span style=color:#ed9366>++</span><span>){
</span><span>    </span><span style=color:#fa6e32>if</span><span>(a[j]) </span><span style=color:#abb0b6;font-style:italic>// 如果存在映射，就释放被映射的缓存块
</span><span>      </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> a[j])</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#f29718>brelse</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 释放一级索引块，并且取消映射
</span><span>  </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT])</span><span style=color:#61676ccc>;
</span><span>  ip</span><span style=color:#ed9366>-></span><span>addrs[NDIRECT] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>  }
</span></code></pre><h3 id=xiu-gai-hou-1><a aria-label="Anchor link for: xiu-gai-hou-1" class=zola-anchor href=#xiu-gai-hou-1>修改后</a></h3><p>和刚刚一样，照葫芦画瓢。<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// 二级索引块处理方法
</span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT]){
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 进入集合块
</span><span>  bp </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT])</span><span style=color:#61676ccc>;
</span><span>  a </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 遍历集合块
</span><span>  </span><span style=color:#fa6e32>for</span><span>(j </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> j </span><span style=color:#ed9366>&lt;</span><span> NINDIRECT</span><span style=color:#61676ccc>;</span><span> j</span><span style=color:#ed9366>++</span><span>){
</span><span>    </span><span style=color:#abb0b6;font-style:italic>// 如果存在一级索引块，进入该块
</span><span>    </span><span style=color:#fa6e32>if</span><span>(a[j]){
</span><span>      bp2 </span><span style=color:#ed9366>= </span><span style=color:#f29718>bread</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> a[j])</span><span style=color:#61676ccc>;
</span><span>      a2 </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#55b4d4;font-style:italic>uint</span><span style=color:#ed9366>*</span><span>)bp2</span><span style=color:#ed9366>-></span><span>data</span><span style=color:#61676ccc>;
</span><span>
</span><span>      </span><span style=color:#abb0b6;font-style:italic>// 清理一级索引块内的地址，和
</span><span>      </span><span style=color:#fa6e32>for</span><span>(k </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> k </span><span style=color:#ed9366>&lt;</span><span> NINDIRECT</span><span style=color:#61676ccc>;</span><span> k</span><span style=color:#ed9366>++</span><span>){
</span><span>        </span><span style=color:#fa6e32>if</span><span>(a2[k])
</span><span>          </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> a2[k])</span><span style=color:#61676ccc>;
</span><span>      }
</span><span>      </span><span style=color:#f29718>brelse</span><span>(bp2)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#abb0b6;font-style:italic>// 释放对应一级索引块
</span><span>      </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> a[j])</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#f29718>brelse</span><span>(bp)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 释放并取消映射二级索引块
</span><span>  </span><span style=color:#f29718>bfree</span><span>(ip</span><span style=color:#ed9366>-></span><span>dev</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT])</span><span style=color:#61676ccc>;
</span><span>  ip</span><span style=color:#ed9366>-></span><span>addrs[DINDIRECT] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=xiao-xiu-xiao-bu><a aria-label="Anchor link for: xiao-xiu-xiao-bu" class=zola-anchor href=#xiao-xiu-xiao-bu>小修小补</a></h2><p>这个是我看whileskies大佬改的，不然的话我肯定不会改，压根不会想到这里，毕竟hints好像也没说呢。<br> 这里要改不要改都行，不影响测试结果，当然改了更好，鲁棒性更高嘛。<p>在<code>file.c/filewrite()</code><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// write a few blocks at a time to avoid exceeding
</span><span style=color:#abb0b6;font-style:italic>// the maximum log transaction size, including
</span><span style=color:#abb0b6;font-style:italic>// i-node, indirect block, allocation blocks,
</span><span style=color:#abb0b6;font-style:italic>// and 2 blocks of slop for non-aligned writes.
</span><span style=color:#abb0b6;font-style:italic>// this really belongs lower down, since writei()
</span><span style=color:#abb0b6;font-style:italic>// might be writing a device like the console.
</span><span style=color:#fa6e32>int</span><span> max </span><span style=color:#ed9366>= </span><span>((MAXOPBLOCKS</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>*</span><span> BSIZE</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=1-he-xin-gai-nian-jie-shi><a aria-label="Anchor link for: 1-he-xin-gai-nian-jie-shi" class=zola-anchor href=#1-he-xin-gai-nian-jie-shi>1. 核心概念解释</a></h3><ul><li><p><strong>MAXOPBLOCKS</strong> （10）<br> 定义在<code>param.h</code>中，表示单个日志事务能容纳的最大块数</p><li><p><strong>max计算式</strong>：<br> <code>((MAXOPBLOCKS-1-1-2)/2)*BSIZE</code><br> 分解说明：</p> <ul><li>第一个-1：为inode块预留<li>第二个-1：为间接块预留<li>-2：安全余量（对齐）<li>/2：保守估计系数 /* 这个是博主乱猜的 */<li>BSIZE(1024)：块大小</ul></ul><p>总而言之，<code>max</code>就是要避免日志溢出（单个事务太大超过日志区域）。<p>我们得改成这样：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>int</span><span> max </span><span style=color:#ed9366>= </span><span>((MAXOPBLOCKS</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>2</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>/ </span><span style=color:#ff8f40>2</span><span>) </span><span style=color:#ed9366>*</span><span> BSIZE</span><span style=color:#61676ccc>;
</span></code></pre><p>就是2个间接块的意思。<h1 id=symbolic-links-moderate><a aria-label="Anchor link for: symbolic-links-moderate" class=zola-anchor href=#symbolic-links-moderate>symbolic links (moderate)</a></h1><p>这个小作业要做的是符号链接/软链接，类似于Windows上的“快捷方式”。<h2 id=ji-chu-gai-nian-ying-lian-jie-yu-ruan-lian-jie-de-qu-bie><a aria-label="Anchor link for: ji-chu-gai-nian-ying-lian-jie-yu-ruan-lian-jie-de-qu-bie" class=zola-anchor href=#ji-chu-gai-nian-ying-lian-jie-yu-ruan-lian-jie-de-qu-bie>基础概念：<strong>硬链接与软链接的区别</strong></a></h2><table><thead><tr><th>区别<th>硬链接<th>软链接<tbody><tr><td>文件标志<td>普通文件<td>T_SYMLINK<tr><td>INODE<td><strong>共享</strong>目标文件<td><strong>独立</strong>新INODE<tr><td>数据<td><strong>共享</strong>目标文件<td>目标文件路径<tr><td>目标文件被删除<td><strong>可</strong>正常访问<td><strong>不可</strong>正常访问<tr><td>跨设备<td><strong>不可</strong>跨设备<td><strong>可</strong>跨设备</table><p>我们暂称软链接文件为“SF”。<br> 当我们创建SF时，它会被打上<strong>T_SYMLINK</strong>的标签，其他普通文件会被打上<strong>T_FILE</strong>的标签。<br> 然后创建后，我们想要打开该文件；系统就会发现它是<strong>T_SYMLINK</strong>标签的文件，并去读取该文件的<code>data</code>字段，<code>data</code>的内容为目标文件的路径，系统会解析该路径，并打开目标文件。<h2 id=shi-xian><a aria-label="Anchor link for: shi-xian" class=zola-anchor href=#shi-xian>实现</a></h2><h3 id=xi-tong-diao-yong><a aria-label="Anchor link for: xi-tong-diao-yong" class=zola-anchor href=#xi-tong-diao-yong>系统调用</a></h3><p>这个读者们应该还记得吧，不记得就翻之前的LAB，这一步是最简单的了，添加系统调用而已，就是让用户态程序能调用内核函数的那步，声明定义一下就行了，先不写实现。<p>这次系统调用长这样：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#f29718>symlink</span><span>(</span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>目标文件</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>新文件路径) </span><span style=color:#abb0b6;font-style:italic>// 不过别真用中文写参数名呀！
</span></code></pre><h3 id=wen-jian-lei-xing-biao-qian><a aria-label="Anchor link for: wen-jian-lei-xing-biao-qian" class=zola-anchor href=#wen-jian-lei-xing-biao-qian>文件类型（标签）</a></h3><p>首先先添加一个新的文件标签，就是刚刚说的那个，因为软链接文件和普通文件的处理方式不同，所以得有自己的标签。<br> <code>kernel/stat.h</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>#define </span><span style=color:#399ee6>T_DIR     </span><span style=color:#ff8f40>1   </span><span style=color:#abb0b6;font-style:italic>// Directory
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>T_FILE    </span><span style=color:#ff8f40>2   </span><span style=color:#abb0b6;font-style:italic>// File
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>T_DEVICE  </span><span style=color:#ff8f40>3   </span><span style=color:#abb0b6;font-style:italic>// Device
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>T_SYMLINK </span><span style=color:#ff8f40>4   </span><span style=color:#abb0b6;font-style:italic>// Symbolic link
</span></code></pre><p>然后有时候我们可能希望直接对这个软链接文件进行操作，比如以下这种场景：<br> 我们现在要打开SF，但是系统不知道我们其实只想看这个SF内所存储的是什么路径，所以它就直接打开了该文件，这不是用户预期行为。<br> 新的文件操作标志做的就是：<br> 不解析SF的路径，直接对SF进行操作。<br> <code>kernel/stat.h</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_RDONLY      </span><span style=color:#ff8f40>0x000
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_WRONLY      </span><span style=color:#ff8f40>0x001
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_RDWR        </span><span style=color:#ff8f40>0x002
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_CREATE      </span><span style=color:#ff8f40>0x200
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_TRUNC       </span><span style=color:#ff8f40>0x400
</span><span style=color:#fa6e32>#define </span><span style=color:#399ee6>O_NOFOLLOW    </span><span style=color:#ff8f40>0x800 
</span></code></pre><h3 id=chuang-jian-ruan-lian-jie-wen-jian><a aria-label="Anchor link for: chuang-jian-ruan-lian-jie-wen-jian" class=zola-anchor href=#chuang-jian-ruan-lian-jie-wen-jian>创建软链接文件</a></h3><p>我们先来做最重要的函数，就是<code>symlink(target, linkpath)</code>。<br> 这个函数要做的事情只有把路径放进新文件里，就这么简单，你甚至不用检查这个路径是否存在文件。<p><code>kernel/sysfile.c</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>sys_symlink</span><span>(</span><span style=color:#fa6e32>void</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>char</span><span> target[MAXPATH]</span><span style=color:#61676ccc>,</span><span> linkpath[MAXPATH]</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#55b4d4;font-style:italic>uint</span><span> len</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>struct</span><span> inode </span><span style=color:#ed9366>*</span><span>op</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>*</span><span>ip</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>argstr</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> target</span><span style=color:#61676ccc>,</span><span> MAXPATH) </span><span style=color:#ed9366>&lt; </span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>|| </span><span style=color:#f29718>argstr</span><span>(</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>,</span><span> linkpath</span><span style=color:#61676ccc>,</span><span> MAXPATH) </span><span style=color:#ed9366>&lt; </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 获取目标文件的INODE
</span><span>  </span><span style=color:#f29718>begin_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>((op </span><span style=color:#ed9366>= </span><span style=color:#f29718>namei</span><span>(target)) </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>ilock</span><span>(op)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>(op</span><span style=color:#ed9366>-></span><span>type </span><span style=color:#ed9366>==</span><span> T_DIR){
</span><span>      </span><span style=color:#f29718>iunlockput</span><span>(op)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f29718>iunlockput</span><span>(op)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 创建软链接文件，并打上软链接对应的标签
</span><span>  </span><span style=color:#fa6e32>if</span><span>((ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>create</span><span>(linkpath</span><span style=color:#61676ccc>,</span><span> T_SYMLINK</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 对软链接文件的DATA写入路径
</span><span>  len </span><span style=color:#ed9366>= </span><span style=color:#f07171>strlen</span><span>(target)</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>writei</span><span>(ip</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>(uint64)target</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> len) </span><span style=color:#ed9366>!=</span><span> len){
</span><span>    </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#f29718>iupdate</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h4 id=di-gui-da-kai><a aria-label="Anchor link for: di-gui-da-kai" class=zola-anchor href=#di-gui-da-kai>递归打开</a></h4><p>我们的软链接文件可能会指向另一个软链接文件，一直指向指向。<br> 所以我们要做一个递归，让系统能够找到目标文件。<br> 但是呢，也不能一直递归，因为用户可能会做65535个，那样的话系统不炸了吗，CPU一直在处理这个东西，太浪费性能了！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>struct</span><span> inode</span><span style=color:#ed9366>*
</span><span style=color:#f29718>find_symlink</span><span>(</span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>path</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>rpath</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>int </span><span style=color:#ff8f40>depth</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>if</span><span>(depth </span><span style=color:#ed9366>>= </span><span style=color:#ff8f40>10</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>struct</span><span> inode </span><span style=color:#ed9366>*</span><span>ip</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>((ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>namei</span><span>(path)) </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>ilock</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>type </span><span style=color:#ed9366>!=</span><span> T_SYMLINK){
</span><span>      </span><span style=color:#f29718>iunlock</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>return</span><span> ip</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>readi</span><span>(ip</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span>(uint64)rpath</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> ip</span><span style=color:#ed9366>-></span><span>size) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#f29718>find_symlink</span><span>(rpath</span><span style=color:#61676ccc>,</span><span> rpath</span><span style=color:#61676ccc>,</span><span> depth</span><span style=color:#ed9366>+</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=da-kai-wen-jian><a aria-label="Anchor link for: da-kai-wen-jian" class=zola-anchor href=#da-kai-wen-jian>打开文件</a></h3><p>我们需要让<code>open()</code>可以处理<code>O_NOFOLLOW</code>的情况，所以就需要改一下。<br> 这里我们要清楚，我们的测试中，<code>O_NOFOLLOW</code>和<code>O_CREATE</code>几乎是不可能出现的，又或者说<code>O_CREATE</code>的优先级比<code>O_NOFOLLOW</code>更大。<br> 一样的，先看原版<br> <code>sysfile.c/sys_open()</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>if</span><span>(omode </span><span style=color:#ed9366>&</span><span> O_CREATE){ </span><span style=color:#abb0b6;font-style:italic>// 创建文件分支
</span><span>  ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>create</span><span>(path</span><span style=color:#61676ccc>,</span><span> T_FILE</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(ip </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>} </span><span style=color:#fa6e32>else </span><span>{ </span><span style=color:#abb0b6;font-style:italic>// 不是要创建那就只有可能是打开了，OPEN函数嘛
</span><span>  </span><span style=color:#fa6e32>if</span><span>((ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>namei</span><span>(path)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){ 
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span style=color:#abb0b6;font-style:italic>/* OTHERS CODE */
</span><span>}
</span></code></pre><p>改成这样：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>if</span><span>(omode </span><span style=color:#ed9366>&</span><span> O_CREATE){ 
</span><span>  ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>create</span><span>(path</span><span style=color:#61676ccc>,</span><span> T_FILE</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(ip </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>  </span><span style=color:#fa6e32>goto</span><span> general</span><span style=color:#61676ccc>;
</span><span>} </span><span style=color:#fa6e32>else if</span><span>(omode </span><span style=color:#ed9366>&</span><span> O_NOFOLLOW) {
</span><span>  </span><span style=color:#fa6e32>if</span><span>((ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>namei</span><span>(path)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){ </span><span style=color:#abb0b6;font-style:italic>// 直接返回INODE
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>} </span><span style=color:#fa6e32>else </span><span>{
</span><span>  </span><span style=color:#fa6e32>char</span><span> rpath[MAXPATH]</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>((ip </span><span style=color:#ed9366>= </span><span style=color:#f29718>find_symlink</span><span>(path</span><span style=color:#61676ccc>,</span><span> rpath</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){ </span><span style=color:#abb0b6;font-style:italic>// 如果找到非软链接文件就会返回INODE
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>} 
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/* 这里开始就不必在意了，重点是上面而已 */
</span><span style=color:#f29718>ilock</span><span>(ip)</span><span style=color:#61676ccc>;  
</span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>type </span><span style=color:#ed9366>==</span><span> T_DIR </span><span style=color:#ed9366>&&</span><span> omode </span><span style=color:#ed9366>!=</span><span> O_RDONLY){
</span><span>  </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span>general</span><span style=color:#ed9366>:
</span><span>  </span><span style=color:#fa6e32>if</span><span>(ip</span><span style=color:#ed9366>-></span><span>type </span><span style=color:#ed9366>==</span><span> T_DEVICE </span><span style=color:#ed9366>&& </span><span>(ip</span><span style=color:#ed9366>-></span><span>major </span><span style=color:#ed9366>&lt; </span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>||</span><span> ip</span><span style=color:#ed9366>-></span><span>major </span><span style=color:#ed9366>>=</span><span> NDEV)){
</span><span>    </span><span style=color:#f29718>iunlockput</span><span>(ip)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>end_op</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/* OTHERS CODE */
</span></code></pre><h2 id=xiao-zhi-shi><a aria-label="Anchor link for: xiao-zhi-shi" class=zola-anchor href=#xiao-zhi-shi>小知识</a></h2><h3 id=posixbiao-zhun-de-o-nofollow><a aria-label="Anchor link for: posixbiao-zhun-de-o-nofollow" class=zola-anchor href=#posixbiao-zhun-de-o-nofollow>POSIX标准的<code>O_NOFOLLOW</code></a></h3><p>POSIX的和XV6的有一些不同。<ul><li>XV6：不要跟随，直接打开软链接文件<li>POSIX：如果路径为软连接文件，直接返回错误</ul><h1 id=wan-jie-sa-hua-o-e-o><a aria-label="Anchor link for: wan-jie-sa-hua-o-e-o" class=zola-anchor href=#wan-jie-sa-hua-o-e-o>完结撒花 (　o=^•ェ•)o　┏━┓</a></h1><p>相信做完这个LAB后，读者们对文件系统多少有点了解了，N级索引、软链接之类的。<br> 不过如果真想了解文件系统的话，还是得精度XV6的其他源码，只是做这个LAB是肯定不够的。<p>那就祝读者们好运啦，拜拜！o(〃＾▽＾〃)o<p>最后编辑时间：2025/8/10</section></article></main><div class=giscus></div><script async crossorigin issue-term=pathname repo=YOUR_NAME/YOUR_REPO src=https://utteranc.es/client.js theme=github-light></script></div>