<!doctype html><html class="dark light" lang=en><head><meta charset=UTF-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://aethernet65535.github.io name=base><title>
            
                XV6-2020 LAB3-PGTBL
            
        </title><meta content="XV6-2020 LAB3-PGTBL" property=og:title><meta content="This is an example description" property=og:description><meta content="This is an example description" name=description><link href=/icon/favicon.png rel=icon type=image/png><link href=https://aethernet65535.github.io/fonts.css rel=stylesheet><script src=https://aethernet65535.github.io/js/codeblock.js></script><script src=https://aethernet65535.github.io/js/toc.js></script><script src=https://aethernet65535.github.io/js/note.js></script><script>MathJax = {
              tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']]
              }
            };</script><script async id=MathJax-script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><link href=https://aethernet65535.github.io/atom.xml rel=alternate title=aethernet-blog type=application/atom+xml><link href=https://aethernet65535.github.io/theme/light.css rel=stylesheet><link href=https://aethernet65535.github.io/theme/dark.css id=darkModeStyle rel=stylesheet><script src=https://aethernet65535.github.io/js/themetoggle.js></script><script>setTheme(getSavedTheme());</script><link href=https://aethernet65535.github.io/main.css media=screen rel=stylesheet><script src="https://aethernet65535.github.io/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><div class=content><header><div class=main><a href=https://aethernet65535.github.io>aethernet-blog</a><div class=socials><a class=social href=https://twitter.com/not_matthias rel=me> <img alt=twitter src=https://aethernet65535.github.io/icons/social/twitter.svg> </a><a class=social href=https://github.com/not-matthias/ rel=me> <img alt=github src=https://aethernet65535.github.io/icons/social/github.svg> </a></div></div><nav><a href=https://aethernet65535.github.io/posts style=margin-left:.25em>/posts</a><a href=https://aethernet65535.github.io/projects style=margin-left:.25em>/projects</a><a href=https://aethernet65535.github.io/about style=margin-left:.25em>/about</a><a href=https://aethernet65535.github.io/tags style=margin-left:.25em>/tags</a><button title="$SHORTCUT to open search" class=search-button id=search-button><img alt=Search class=search-icon src=https://aethernet65535.github.io/icons/search.svg></button><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><div id=modal-content><h1 class=page-header id=modalTitle>Search</h1><div id=searchBar><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search... role=combobox spellcheck=false><button title="Clear search" class=clear-button id=clear-search><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></button></div><div id=results-container><div id=results-info><span id=zero_results style=display:none>No results</span><span id=one_result style=display:none>1 result</span><span id=many_results style=display:none>$NUMBER results</span></div><div id=results role=listbox></div></div></div></div><a onclick="toggleTheme(); event.preventDefault();" href=# id=dark-mode-toggle> <img alt=Light id=sun-icon src=https://aethernet65535.github.io/icons/sun.svg style=filter:invert()> <img alt=Dark id=moon-icon src=https://aethernet65535.github.io/icons/moon.svg> </a><script>updateItemToggleTheme()</script></nav></header><main><article><div class=title><div class=page-header>XV6-2020 LAB3-PGTBL<span class=primary-color style=font-size:1.6em>.</span></div><div class=meta>Posted on <time>2025-06-07</time> :: 2664 Words <span class=tags-label>:: Tags:</span><span class=tags> <a class=post-tag href=https://aethernet65535.github.io/tags/xv6/>xv6</a> </span></div></div><div class=toc-container><h1 class=toc-title>Table of Contents</h1><ul class=toc-list><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#qian-yan>前言</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#print-a-page-table-easy>print a page table (easy)</a> <ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#ye-sheng-de-da-an>野生的答案！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#ye-sheng-de-zai-jia-gong>野生的再加工！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#diao-yong>调用！</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#a-kernel-page-table-per-process-hard>a kernel page table per process (hard)</a> <ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#nei-he-ye-biao-fu-ben-zi-duan>内核页表副本字段</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#chuang-jian-nei-he-ye-biao-fu-ben>创建内核页表副本</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#jiang-qi-fen-pei-zhi-jin-cheng>将其分配至进程</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#jiang-qi-shan-chu>将其删除！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#quan-bu-shan-chu>全部删除！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#nei-he-zhan-zhuan-yi>内核栈转移</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#xiao-xiu-xiao-bu>小修小补</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#satpzhi-xiang-quan-ju-nei-he-ye-biao-nei-he-ye-biao-fu-ben>SATP指向全局内核页表？内核页表副本！</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#simplify-copyin-copyinstr-hard>simplify copyin/copyinstr (hard)</a> <ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#en-si>恩赐</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#nei-he-he-yong-hu-tong-bu-xiu-gai-di-ceng-dai-ma>内核和用户同步！（修改底层代码！）</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#xun-zhao>寻找</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#shan-chu-bu-shan-chu>删除？不删除！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#xian-zhi-sheng-chang>限制生长！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#da-gai>大改！</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#ng-zen-me-bao-cuo>嗯？怎么报错？</a><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#wan-jie-sa-hua>完结撒花</a></ul><li><a href=https://aethernet65535.github.io/posts/xv6-2020-lab3-pgtbl/#chang-jian-yi-wen>常见疑问</a></ul></div><section class=body><h2 id=qian-yan><a aria-label="Anchor link for: qian-yan" class=zola-anchor href=#qian-yan>前言</a></h2><p>好，这个就是最难的LAB了（我觉得）。如果说LAB1、2是小学水平，那么LAB3至少都是高中水平了，真的难。<br> 不过，做完之后，你会发现你的水平有了大提升，页表很难，不过也很有趣。<p>先提醒一下，如果你还没读<code>xv6-book</code>，或是还没看<code>MIT S6.081</code>的公开课，我建议你去看一下，页表我学了有差不多1个月吧，很难真的。（也有可能是我太菜了嘤嘤嘤QAQ）<p>好，那我们开始吧！<h2 id=print-a-page-table-easy><a aria-label="Anchor link for: print-a-page-table-easy" class=zola-anchor href=#print-a-page-table-easy>print a page table (easy)</a></h2><p>这个难度是<code>easy</code>，事实也确实如此，因为这个是最后的<code>easy</code>了，之后就是大boss了。<br> 如果你有去看我的<code>GITHUB REPO</code>，你可能会觉得我的代码很奇怪，我这里说明一下我的代码的作用。<br> 我写的那些是用来输出<code>VA</code>和<code>PERM</code>的，没什么用，我DEBUG是完全没用到<code>VMPRINT</code>，那些代码可以不抄，毕竟不是作业要求。<br> 如果你去修改代码调用我的版本，输出会是这样的：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>PAGETABLE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f1c000
</span><span style=color:#ed9366>|--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000000000000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc6001</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f18000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x1
</span><span style=color:#ed9366>|-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000000000000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc5c01</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f17000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x3073
</span><span style=color:#ed9366>|-- |-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000000000000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc641f</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f19000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x1055
</span><span style=color:#ed9366>|-- |-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000000001000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc540f</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f15000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x1039
</span><span style=color:#ed9366>|-- |-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000000002000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc501f</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f14000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x31
</span><span style=color:#ed9366>|--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000003fc0000000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc6c01</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f1b000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x3073
</span><span style=color:#ed9366>|-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000003fffe00000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fc6801</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087f1a000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x2049
</span><span style=color:#ed9366>|-- |-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000003fffffe000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000021fed807</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000087fb6000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x2055
</span><span style=color:#ed9366>|-- |-- |--</span><span> VA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000003ffffff000</span><span> PTE</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000020001c0b</span><span> PA</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x0000000080007000</span><span> PERM</span><span style=color:#ed9366>:</span><span style=color:#ff8f40>0x3083
</span></code></pre><p>我放一下作业要求的输出：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>page table </span><span style=color:#ff8f40>0x0000000087f6e000
</span><span style=color:#f51818>..</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fda801</span><span> pa </span><span style=color:#ff8f40>0x0000000087f6a000
</span><span style=color:#f51818>.. ..</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fda401</span><span> pa </span><span style=color:#ff8f40>0x0000000087f69000
</span><span style=color:#f51818>.. .. ..</span><span style=color:#ff8f40>0</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fdac1f</span><span> pa </span><span style=color:#ff8f40>0x0000000087f6b000
</span><span style=color:#f51818>.. .. ..</span><span style=color:#ff8f40>1</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fda00f</span><span> pa </span><span style=color:#ff8f40>0x0000000087f68000
</span><span style=color:#f51818>.. .. ..</span><span style=color:#ff8f40>2</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fd9c1f</span><span> pa </span><span style=color:#ff8f40>0x0000000087f67000
</span><span style=color:#f51818>..</span><span style=color:#ff8f40>255</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fdb401</span><span> pa </span><span style=color:#ff8f40>0x0000000087f6d000
</span><span style=color:#f51818>.. ..</span><span style=color:#ff8f40>511</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fdb001</span><span> pa </span><span style=color:#ff8f40>0x0000000087f6c000
</span><span style=color:#f51818>.. .. ..</span><span style=color:#ff8f40>510</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000021fdd807</span><span> pa </span><span style=color:#ff8f40>0x0000000087f76000
</span><span style=color:#f51818>.. .. ..</span><span style=color:#ff8f40>511</span><span style=color:#ed9366>:</span><span> pte </span><span style=color:#ff8f40>0x0000000020001c0b</span><span> pa </span><span style=color:#ff8f40>0x0000000080007000
</span></code></pre><p>好，废话很多了，我们来开始做第一个实验吧。<h3 id=ye-sheng-de-da-an><a aria-label="Anchor link for: ye-sheng-de-da-an" class=zola-anchor href=#ye-sheng-de-da-an>野生的答案！</a></h3><p>首先，我们先来看一下<code>freewalk</code>函数：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>void
</span><span style=color:#f29718>freewalk</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span>)
</span><span>{
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// there are 2^9 = 512 PTEs in a page table.
</span><span>  </span><span style=color:#fa6e32>for</span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>512</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){
</span><span>    pte_t pte </span><span style=color:#ed9366>=</span><span> pagetable[i]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>((pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>&& </span><span>(pte </span><span style=color:#ed9366>& </span><span>(PTE_R</span><span style=color:#ed9366>|</span><span>PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      </span><span style=color:#abb0b6;font-style:italic>// this PTE points to a lower-level page table.
</span><span>      uint64 child </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(pte)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>freewalk</span><span>((pagetable_t)child)</span><span style=color:#61676ccc>;
</span><span>      pagetable[i] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    } </span><span style=color:#fa6e32>else if</span><span>(pte </span><span style=color:#ed9366>&</span><span> PTE_V){
</span><span>      </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"freewalk: leaf"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#f29718>kfree</span><span>((</span><span style=color:#fa6e32>void</span><span style=color:#ed9366>*</span><span>)pagetable)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>他的作用就是：<ol><li>遍历512个PTE：</ol><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>for</span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>512</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){
</span><span>    pte_t pte </span><span style=color:#ed9366>=</span><span> pagetable[i]</span><span style=color:#61676ccc>;
</span></code></pre><ol start=2><li>处理中间页表： 检查<code>PTE</code>是否为<code>VALID</code>，并且没有<code>READ</code>、<code>WRITE</code>、<code>EXECUTE</code>权限。如果是的话说明这是中间页表，如果有那三个权限中的任意一个的话，就是叶子节点了。（指向物理内存的页表） 通过<code>PTE2PA</code>获得下一个页表的地址然后递归调用：</ol><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>if</span><span>((pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>&& </span><span>(pte </span><span style=color:#ed9366>& </span><span>(PTE_R</span><span style=color:#ed9366>|</span><span>PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      uint64 child </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(pte)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>freewalk</span><span>((pagetable_t)child)</span><span style=color:#61676ccc>;
</span></code></pre><ol start=3><li>错误处理： 如果发现是叶子页表，那就要直接内核恐慌了（<code>kernel panic</code>），因为一般是开发者自行更改页表才会出现这种问题，比起数据遭到预期以为的修改，直接死机是更好的选择。</ol><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>else if</span><span>(pte </span><span style=color:#ed9366>&</span><span> PTE_V){
</span><span>      </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"freewalk: leaf"</span><span>)</span><span style=color:#61676ccc>;
</span></code></pre><p>我说的可能有点绕，简单来说就是，如果叶子节点是有效的，那就代表它还是有数据的，我们不应该清空有数据的页表。<br> 至少这不是<code>freewalk</code>需要做的，这是<code>uvmunmap</code>做的，感兴趣的可以去<code>kernel/proc.c</code>和<code>kernel/vm.c</code>看看。 4. 释放当前页表：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#f29718>kfree</span><span>((</span><span style=color:#fa6e32>void</span><span style=color:#ed9366>*</span><span>)pagetable)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 这个可以执行很多次，有几次取决于你的pagetable总共有多少个 
</span></code></pre><p>这之后，你的页表们都会被放进<code>freelist</code>。<h3 id=ye-sheng-de-zai-jia-gong><a aria-label="Anchor link for: ye-sheng-de-zai-jia-gong" class=zola-anchor href=#ye-sheng-de-zai-jia-gong>野生的再加工！</a></h3><p>好，可以开始做实验了。<br> 首先，去打开<code>kernel/vm.c</code>。<br> 然后，实验代码就是这个：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>void
</span><span style=color:#f29718>vmprint_ori</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>int </span><span style=color:#ff8f40>level</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>for</span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>512</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){
</span><span>    pte_t pte </span><span style=color:#ed9366>=</span><span> pagetable[i]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if </span><span>(</span><span style=color:#ed9366>!</span><span>(pte </span><span style=color:#ed9366>&</span><span> PTE_V)) </span><span style=color:#fa6e32>continue</span><span style=color:#61676ccc>;
</span><span>
</span><span>    </span><span style=color:#fa6e32>for </span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>3</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>></span><span> level</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>--</span><span>) {
</span><span>      </span><span style=color:#f07171>printf</span><span>(</span><span style=color:#86b300>".."</span><span>)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>if</span><span>(i</span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1 </span><span style=color:#ed9366>></span><span> level){
</span><span>        </span><span style=color:#f07171>printf</span><span>(</span><span style=color:#86b300>" "</span><span>)</span><span style=color:#61676ccc>;
</span><span>      }
</span><span>    }
</span><span>    </span><span style=color:#f07171>printf</span><span>(</span><span style=color:#86b300>"</span><span style=color:#ff8f40>%d</span><span style=color:#86b300>: pte </span><span style=color:#ff8f40>%p</span><span style=color:#86b300> pa </span><span style=color:#ff8f40>%p</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> i</span><span style=color:#61676ccc>,</span><span> pte</span><span style=color:#61676ccc>, </span><span style=color:#f29718>PTE2PA</span><span>(pte))</span><span style=color:#61676ccc>;
</span><span>      
</span><span>    </span><span style=color:#fa6e32>if</span><span>((pte </span><span style=color:#ed9366>& </span><span>(PTE_R</span><span style=color:#ed9366>|</span><span>PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      uint64 child </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(pte)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>vmprint_ori</span><span>((pagetable_t)child</span><span style=color:#61676ccc>,</span><span> level </span><span style=color:#ed9366>- </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>}
</span><span>
</span><span style=color:#fa6e32>void 
</span><span style=color:#f29718>vmprint</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span>)
</span><span>{
</span><span>  </span><span style=color:#f07171>printf</span><span>(</span><span style=color:#86b300>"page table </span><span style=color:#ff8f40>%p</span><span style=color:#4cbf99>\n</span><span style=color:#86b300>"</span><span style=color:#61676ccc>,</span><span> pagetable)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>vmprint_ori</span><span>(pagetable</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>2</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=diao-yong><a aria-label="Anchor link for: diao-yong" class=zola-anchor href=#diao-yong>调用！</a></h3><p>然后我们打开<code>kernel/exec.c</code>。<br> 实验代码如下：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// Commit to the user image.
</span><span>  oldpagetable </span><span style=color:#ed9366>=</span><span> p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>;
</span><span>  p</span><span style=color:#ed9366>-></span><span>pagetable </span><span style=color:#ed9366>=</span><span> pagetable</span><span style=color:#61676ccc>;
</span><span>  p</span><span style=color:#ed9366>-></span><span>sz </span><span style=color:#ed9366>=</span><span> sz</span><span style=color:#61676ccc>;
</span><span>  p</span><span style=color:#ed9366>-></span><span>trapframe</span><span style=color:#ed9366>-></span><span>epc </span><span style=color:#ed9366>=</span><span> elf</span><span style=color:#ed9366>.</span><span>entry</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// initial program counter = main
</span><span>  p</span><span style=color:#ed9366>-></span><span>trapframe</span><span style=color:#ed9366>-></span><span>sp </span><span style=color:#ed9366>=</span><span> sp</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// initial stack pointer
</span><span>  </span><span style=color:#f29718>proc_freepagetable</span><span>(oldpagetable</span><span style=color:#61676ccc>,</span><span> oldsz)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 添加这个
</span><span>  </span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>pid </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>1</span><span>)
</span><span>    </span><span style=color:#f29718>vmprint</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable)</span><span style=color:#61676ccc>;
</span></code></pre><p>然后去跑跑TEST，应该就可以通过了，那个回答问题的测试你自己<code>touch</code>一个然后写答案就可以了。<h2 id=a-kernel-page-table-per-process-hard><a aria-label="Anchor link for: a-kernel-page-table-per-process-hard" class=zola-anchor href=#a-kernel-page-table-per-process-hard>a kernel page table per process (hard)</a></h2><p>好，这个就是卡我最久的LAB了，是真的难。（2个月左右）<p>好！我们先来看看这个LAB是要做什么吧！<br> 首先，XV6的页表现在是怎么样的呢？<p>XV6的页表是这样的： 每个用户进程，在用户态运行时，都使用自己的用户态页表。<br> 但是，一旦进入内核态，就要切换到内核页表，现在这个内核页表是全局的。<p>这个实验要我们做的就是，让每个用户进程都有自己的内核页表。<br> 嘛不过，分两步，这个LAB和下一个关系很大，不可以先去做下一个LAB！<br> 这个LAB要做的是让XV6从全局内核页表进化为全局+多个副本，并且效果和现在一样。（就是不报错，所有功能正常）<br> 下一个LAB才是让完善这种进程页表。<blockquote><p>这个LAB会改变的：<ul><li>❎ 内核页表有各自用户页表的映射<li>✅ 每个用户进程在内核态将会使用自己的内核页表</ul></blockquote><p>好，开始吧！<h3 id=nei-he-ye-biao-fu-ben-zi-duan><a aria-label="Anchor link for: nei-he-ye-biao-fu-ben-zi-duan" class=zola-anchor href=#nei-he-ye-biao-fu-ben-zi-duan>内核页表副本字段</a></h3><p>首先我们要先让我们的进程有一个新的字段。<br> 和<code>pagetable</code>差不多，不过是内核的，所以就叫<code>kpagetable</code>吧！<br> 在<code>kernel/proc.h</code>加上新字段：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>struct </span><span style=color:#399ee6>proc </span><span>{
</span><span>  </span><span style=color:#fa6e32>struct</span><span> spinlock lock</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// p->lock must be held when using these:
</span><span>  </span><span style=color:#fa6e32>enum</span><span> procstate state</span><span style=color:#61676ccc>;        </span><span style=color:#abb0b6;font-style:italic>// Process state
</span><span>  </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>proc</span><span> *parent</span><span style=color:#61676ccc>;         </span><span style=color:#abb0b6;font-style:italic>// Parent process
</span><span>  </span><span style=color:#fa6e32>void </span><span style=color:#ed9366>*</span><span>chan</span><span style=color:#61676ccc>;                  </span><span style=color:#abb0b6;font-style:italic>// If non-zero, sleeping on chan
</span><span>  </span><span style=color:#fa6e32>int</span><span> killed</span><span style=color:#61676ccc>;                  </span><span style=color:#abb0b6;font-style:italic>// If non-zero, have been killed
</span><span>  </span><span style=color:#fa6e32>int</span><span> xstate</span><span style=color:#61676ccc>;                  </span><span style=color:#abb0b6;font-style:italic>// Exit status to be returned to parent's wait
</span><span>  </span><span style=color:#fa6e32>int</span><span> pid</span><span style=color:#61676ccc>;                     </span><span style=color:#abb0b6;font-style:italic>// Process ID
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// these are private to the process, so p->lock need not be held.
</span><span>  uint64 kstack</span><span style=color:#61676ccc>;               </span><span style=color:#abb0b6;font-style:italic>// Virtual address of kernel stack
</span><span>  uint64 sz</span><span style=color:#61676ccc>;                   </span><span style=color:#abb0b6;font-style:italic>// Size of process memory (bytes)
</span><span>  pagetable_t pagetable</span><span style=color:#61676ccc>;       </span><span style=color:#abb0b6;font-style:italic>// User page table
</span><span>  </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>trapframe</span><span> *trapframe</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// data page for trampoline.S
</span><span>  </span><span style=color:#fa6e32>struct</span><span> context context</span><span style=color:#61676ccc>;      </span><span style=color:#abb0b6;font-style:italic>// swtch() here to run process
</span><span>  </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>file</span><span> *ofile[NOFILE]</span><span style=color:#61676ccc>;  </span><span style=color:#abb0b6;font-style:italic>// Open files
</span><span>  </span><span style=color:#fa6e32>struct </span><span style=color:#399ee6>inode</span><span> *cwd</span><span style=color:#61676ccc>;           </span><span style=color:#abb0b6;font-style:italic>// Current directory
</span><span>  </span><span style=color:#fa6e32>char</span><span> name[</span><span style=color:#ff8f40>16</span><span>]</span><span style=color:#61676ccc>;               </span><span style=color:#abb0b6;font-style:italic>// Process name (debugging)
</span><span>  
</span><span>  pagetable_t kpagetable</span><span style=color:#61676ccc>;      </span><span style=color:#abb0b6;font-style:italic>// 添加这个，以后我们的内核页表就是这个了
</span><span>}</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=chuang-jian-nei-he-ye-biao-fu-ben><a aria-label="Anchor link for: chuang-jian-nei-he-ye-biao-fu-ben" class=zola-anchor href=#chuang-jian-nei-he-ye-biao-fu-ben>创建内核页表副本</a></h3><p>然后我们要模仿<code>kvminit</code>，这样就能给进程内核页表分东西了。<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>pagetable_t
</span><span style=color:#f29718>kvmmake</span><span>(</span><span style=color:#fa6e32>int </span><span style=color:#ff8f40>global</span><span>) 
</span><span style=color:#abb0b6;font-style:italic>// 这个参数主要是用来区分全局和副本的
</span><span style=color:#abb0b6;font-style:italic>// 副本放CLINT会报错，具体怎么修复我也不知道，目前已知的就是不分配
</span><span>{
</span><span>  pagetable_t kpagetable </span><span style=color:#ed9366>= </span><span>(pagetable_t) </span><span style=color:#f29718>kalloc</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f07171>memset</span><span>(kpagetable</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> PGSIZE)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// uart registers
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> UART0</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>,</span><span> UART0</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// virtio mmio disk interface
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> VIRTIO0</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>,</span><span> VIRTIO0</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(global </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>1</span><span>)
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// CLINT
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> CLINT</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0x10000</span><span style=color:#61676ccc>,</span><span> CLINT</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// PLIC
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> PLIC</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0x400000</span><span style=color:#61676ccc>,</span><span> PLIC</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// map kernel text executable and read-only.
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> KERNBASE</span><span style=color:#61676ccc>, </span><span>(uint64)etext</span><span style=color:#ed9366>-</span><span>KERNBASE</span><span style=color:#61676ccc>,</span><span> KERNBASE</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_X)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// map kernel data and the physical RAM we'll make use of.
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>, </span><span>(uint64)etext</span><span style=color:#61676ccc>,</span><span> PHYSTOP</span><span style=color:#ed9366>-</span><span>(uint64)etext</span><span style=color:#61676ccc>, </span><span>(uint64)etext</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// map the trampoline for trap entry/exit to
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// the highest virtual address in the kernel.
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> TRAMPOLINE</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)trampoline</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_X)</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>return</span><span> kpagetable</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>/*
</span><span style=color:#abb0b6;font-style:italic> * create a direct-map page table for the kernel.
</span><span style=color:#abb0b6;font-style:italic> */
</span><span style=color:#fa6e32>void
</span><span style=color:#f29718>kvminit</span><span>()
</span><span>{
</span><span>  kernel_pagetable </span><span style=color:#ed9366>= </span><span style=color:#f29718>kvmmake</span><span>(</span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=jiang-qi-fen-pei-zhi-jin-cheng><a aria-label="Anchor link for: jiang-qi-fen-pei-zhi-jin-cheng" class=zola-anchor href=#jiang-qi-fen-pei-zhi-jin-cheng>将其分配至进程</a></h3><p>接下来，我们要把这个副本放进进程里，在<code>kernel/proc.c</code>的<code>allocproc</code>函数添加以下代码：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span> </span><span style=color:#abb0b6;font-style:italic>// An empty user page table.
</span><span>  p</span><span style=color:#ed9366>-></span><span>pagetable </span><span style=color:#ed9366>= </span><span style=color:#f29718>proc_pagetable</span><span>(p)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>freeproc</span><span>(p)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>release</span><span>(</span><span style=color:#ed9366>&</span><span>p</span><span style=color:#ed9366>-></span><span>lock)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 添加这个
</span><span>  p</span><span style=color:#ed9366>-></span><span>kpagetable </span><span style=color:#ed9366>= </span><span style=color:#f29718>kvmmake</span><span>(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 正如刚刚所说的，这是副本，所以用参数0
</span><span>  </span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>    </span><span style=color:#f29718>freeproc</span><span>(p)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>release</span><span>(</span><span style=color:#ed9366>&</span><span>p</span><span style=color:#ed9366>-></span><span>lock)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=jiang-qi-shan-chu><a aria-label="Anchor link for: jiang-qi-shan-chu" class=zola-anchor href=#jiang-qi-shan-chu>将其删除！</a></h3><p>因为我们分配了新东西，所以我们要释放进程时也要让系统知道我们要释放新东西！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable)
</span><span>    </span><span style=color:#f29718>proc_freepagetable</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>sz)</span><span style=color:#61676ccc>;
</span><span>  p</span><span style=color:#ed9366>-></span><span>pagetable </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 要释放新东西！
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 一定要先释放KSTACK！不然会报错！
</span><span>  </span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>kstack)
</span><span>    </span><span style=color:#f29718>uvmunmap</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>kstack</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>  p</span><span style=color:#ed9366>-></span><span>kstack </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable)
</span><span>    </span><span style=color:#f29718>kvmfree</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 这个是新函数，之后你会看到的
</span><span>  p</span><span style=color:#ed9366>-></span><span>kpagetable </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=quan-bu-shan-chu><a aria-label="Anchor link for: quan-bu-shan-chu" class=zola-anchor href=#quan-bu-shan-chu>全部删除！</a></h3><p>看到上面的<code>kvmfree</code>了对吧？这不是XV6自己的函数，是我们自己实现的函数，具体怎么实现就看这里：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>void
</span><span style=color:#f29718>kvmfree</span><span>(pagetable_t </span><span style=color:#ff8f40>kpagetable</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>for</span><span>(</span><span style=color:#fa6e32>int</span><span> i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>512</span><span style=color:#61676ccc>;</span><span> i</span><span style=color:#ed9366>++</span><span>){
</span><span>    pte_t pte </span><span style=color:#ed9366>=</span><span> kpagetable[i]</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>(pte </span><span style=color:#ed9366>&</span><span> PTE_V) 
</span><span>      kpagetable[i] </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>((pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>&& </span><span>(pte </span><span style=color:#ed9366>& </span><span>(PTE_R</span><span style=color:#ed9366>|</span><span>PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      uint64 child </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(pte)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>kvmfree</span><span>((pagetable_t)child)</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#f29718>kfree</span><span>((</span><span style=color:#fa6e32>void</span><span style=color:#ed9366>*</span><span>)kpagetable)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>你可能发现了，这不就是<code>freewalk</code>吗？<br> 那确实差不多，但是差了一些，<code>kvmfree</code>呢，他是不管<code>L0 PTE</code>还有没有指向数据都给你删的，如果是freewalk的话，他是禁止删除指向数据的<code>L0 PTE</code>的。 总结一下区别就是：<ul><li>freewalk：L0还指向数据？不能删，PANIC！<li>kvmfree：L0还指向数据？不过代码让都让我删了，删吧，开发者自己会负责的。</ul><h3 id=nei-he-zhan-zhuan-yi><a aria-label="Anchor link for: nei-he-zhan-zhuan-yi" class=zola-anchor href=#nei-he-zhan-zhuan-yi>内核栈转移</a></h3><p>之后，我们看看<code>kernel/proc.c</code>里的<code>procinit</code>函数，我们会发现，这里有一段分配内核栈的代码：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// Allocate a page for the process's kernel stack.
</span><span style=color:#abb0b6;font-style:italic>// Map it high in memory, followed by an invalid
</span><span style=color:#abb0b6;font-style:italic>// guard page.
</span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>kalloc</span><span>()</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 分配一页
</span><span style=color:#fa6e32>if</span><span>(pa </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>) </span><span style=color:#abb0b6;font-style:italic>// 错误处理（如果没分配成功）
</span><span>  </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"kalloc"</span><span>)</span><span style=color:#61676ccc>;
</span><span>uint64 va </span><span style=color:#ed9366>= </span><span style=color:#f29718>KSTACK</span><span>((</span><span style=color:#fa6e32>int</span><span>) (p </span><span style=color:#ed9366>-</span><span> proc))</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 计算出VA的地址
</span><span style=color:#f29718>kvmmap</span><span>(va</span><span style=color:#61676ccc>, </span><span>(uint64)pa</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 把内核栈分配到全局内核页表
</span><span>p</span><span style=color:#ed9366>-></span><span>kstack </span><span style=color:#ed9366>=</span><span> va</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// 让进程自己知道内核栈的地址
</span></code></pre><p>我们得把它剪切下来，然后粘贴到<code>allocproc</code>，并修改一些代码：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>kalloc</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>if</span><span>(pa </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>  </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"kalloc"</span><span>)</span><span style=color:#61676ccc>;
</span><span>uint64 va </span><span style=color:#ed9366>= </span><span style=color:#f29718>KSTACK</span><span>((</span><span style=color:#fa6e32>int</span><span>) (p </span><span style=color:#ed9366>-</span><span> proc))</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>mappages</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> va</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)pa</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span>p</span><span style=color:#ed9366>-></span><span>kstack </span><span style=color:#ed9366>=</span><span> va</span><span style=color:#61676ccc>;
</span></code></pre><p>我们修改的代码是：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#f29718>kvmmap</span><span>(va</span><span style=color:#61676ccc>, </span><span>(uint64)pa</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>mappages</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> va</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)pa</span><span style=color:#61676ccc>,</span><span> PTE_R </span><span style=color:#ed9366>|</span><span> PTE_W)</span><span style=color:#61676ccc>;
</span></code></pre><p><code>kvmmap</code>版做的是把内核栈分配给全局内核页表。<br> 但是这个LAB要我们做的就是把全局内核页表的东西搬到或映射到内核页表副本。<p>所以我们的<code>mappages</code>版本做的就是把它分配到进程自己的内核页表副本。<h3 id=xiao-xiu-xiao-bu><a aria-label="Anchor link for: xiao-xiu-xiao-bu" class=zola-anchor href=#xiao-xiu-xiao-bu>小修小补</a></h3><p>之后我们还要改一个地方，这个hint没有说，不过是肯定要改的，不然会报错。<br> 在<code>kernel/vm.c</code>的kvmpa函数，修改一些代码：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>kvmpa</span><span>(uint64 </span><span style=color:#ff8f40>va</span><span>)
</span><span>{
</span><span>  uint64 off </span><span style=color:#ed9366>=</span><span> va </span><span style=color:#ed9366>%</span><span> PGSIZE</span><span style=color:#61676ccc>;
</span><span>  pte_t </span><span style=color:#ed9366>*</span><span>pte</span><span style=color:#61676ccc>;
</span><span>  uint64 pa</span><span style=color:#61676ccc>;
</span><span> 
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 从全局页表改为页表副本
</span><span>  pte </span><span style=color:#ed9366>= </span><span style=color:#f29718>walk</span><span>(</span><span style=color:#f29718>myproc</span><span>()</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> va</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(pte </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"kvmpa"</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>((</span><span style=color:#ed9366>*</span><span>pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"kvmpa"</span><span>)</span><span style=color:#61676ccc>;
</span><span>  pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(</span><span style=color:#ed9366>*</span><span>pte)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>return</span><span> pa</span><span style=color:#ed9366>+</span><span>off</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=satpzhi-xiang-quan-ju-nei-he-ye-biao-nei-he-ye-biao-fu-ben><a aria-label="Anchor link for: satpzhi-xiang-quan-ju-nei-he-ye-biao-nei-he-ye-biao-fu-ben" class=zola-anchor href=#satpzhi-xiang-quan-ju-nei-he-ye-biao-nei-he-ye-biao-fu-ben>SATP指向全局内核页表？内核页表副本！</a></h3><p>如果你有看<code>kernel/main.c</code>，你可能会发现，XV6初始化后，就会进入<code>scheduler</code>函数找进程，<code>main.c</code>我们就像不看了，毕竟这LAB也没有必要看那个（而且我也看不懂（＞人＜；））<p>好，那我们就来看<code>kernel/proc.c</code>的<code>scheduler</code>函数：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>p</span><span style=color:#ed9366>-></span><span>state </span><span style=color:#ed9366>=</span><span> RUNNING</span><span style=color:#61676ccc>;
</span><span>c</span><span style=color:#ed9366>-></span><span>proc </span><span style=color:#ed9366>=</span><span> p</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 切换至内核页表副本
</span><span style=color:#f29718>w_satp</span><span>(</span><span style=color:#f29718>MAKE_SATP</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable))</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>sfence_vma</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// （继续）执行进程
</span><span style=color:#f29718>swtch</span><span>(</span><span style=color:#ed9366>&</span><span>c</span><span style=color:#ed9366>-></span><span>context</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>p</span><span style=color:#ed9366>-></span><span>context)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 进程暂停/结束后
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 切换到全局内核页表！
</span><span style=color:#f29718>kvminithart</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 如果找不到进程跑的话，就先在全局页表观望观望
</span><span style=color:#fa6e32>if</span><span>(found </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>) {
</span><span>  </span><span style=color:#f29718>kvminithart</span><span>()</span><span style=color:#61676ccc>; 
</span><span>
</span><span>  </span><span style=color:#f29718>intr_on</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>asm volatile</span><span>(</span><span style=color:#86b300>"wfi"</span><span>)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h2 id=simplify-copyin-copyinstr-hard><a aria-label="Anchor link for: simplify-copyin-copyinstr-hard" class=zola-anchor href=#simplify-copyin-copyinstr-hard>simplify copyin/copyinstr (hard)</a></h2><p>好，这里就能给整个LAB3弄出一个惊天大改了！因为我们要真的有一个厉害的内核页表副本了！<blockquote><p>这个LAB会改变的：<ul><li>✅ 内核页表有各自用户页表的映射<li>✅ 每个用户进程在内核态将会使用自己的内核页表</ul></blockquote><p>就是这样，做好这个之后，XV6就会有一个真·内核页表副本了，不止映射内核，还映射用户空间！<br> 那话不多说，我们，开始吧~<h3 id=en-si><a aria-label="Anchor link for: en-si" class=zola-anchor href=#en-si>恩赐</a></h3><p>XV6很好的给我们准备了<code>copyin</code>和<code>copyinstr</code>，可以在<code>kernel/vmcopyin.c</code>看到，我们先去<code>kernel/defs.h</code>那里声明原型，然后直接去<code>kernel/vm.c</code>更换就行了：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// Copy from user to kernel.
</span><span style=color:#abb0b6;font-style:italic>// Copy len bytes to dst from virtual address srcva in a given page table.
</span><span style=color:#abb0b6;font-style:italic>// Return 0 on success, -1 on error.
</span><span style=color:#fa6e32>int
</span><span style=color:#f29718>copyin</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>dst</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>srcva</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>len</span><span>)
</span><span>{
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 之前的代码通通删掉！！注释也行
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#f29718>copyin_new</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> dst</span><span style=color:#61676ccc>,</span><span> srcva</span><span style=color:#61676ccc>,</span><span> len)</span><span style=color:#61676ccc>;
</span><span>}
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// Copy a null-terminated string from user to kernel.
</span><span style=color:#abb0b6;font-style:italic>// Copy bytes to dst from virtual address srcva in a given page table,
</span><span style=color:#abb0b6;font-style:italic>// until a '\0', or max.
</span><span style=color:#abb0b6;font-style:italic>// Return 0 on success, -1 on error.
</span><span style=color:#fa6e32>int
</span><span style=color:#f29718>copyinstr</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>dst</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>srcva</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>max</span><span>)
</span><span>{
</span><span>  </span><span style=color:#abb0b6;font-style:italic>// 一样，通通删掉
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#f29718>copyinstr_new</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> dst</span><span style=color:#61676ccc>,</span><span> srcva</span><span style=color:#61676ccc>,</span><span> max)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=nei-he-he-yong-hu-tong-bu-xiu-gai-di-ceng-dai-ma><a aria-label="Anchor link for: nei-he-he-yong-hu-tong-bu-xiu-gai-di-ceng-dai-ma" class=zola-anchor href=#nei-he-he-yong-hu-tong-bu-xiu-gai-di-ceng-dai-ma>内核和用户同步！（修改底层代码！）</a></h3><p>在我们每次修改用户内存时，我们就让内核页表副本也一同修改就行了，这样不就可以同步了嘛（(￣y▽,￣)╭ ）：<p>第一个，是我们分配内存时，也要给自己的内核分配一下！<br> 所以我们得去<code>kernel/vm.c</code>修改一些东西：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>uvmalloc</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>,</span><span> pagetable_t </span><span style=color:#ff8f40>kpagetable</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>oldsz</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>newsz</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>mem</span><span style=color:#61676ccc>;
</span><span>  uint64 a</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(newsz </span><span style=color:#ed9366><</span><span> oldsz)
</span><span>    </span><span style=color:#fa6e32>return</span><span> oldsz</span><span style=color:#61676ccc>;
</span><span>
</span><span>  oldsz </span><span style=color:#ed9366>= </span><span style=color:#f29718>PGROUNDUP</span><span>(oldsz)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>for</span><span>(a </span><span style=color:#ed9366>=</span><span> oldsz</span><span style=color:#61676ccc>;</span><span> a </span><span style=color:#ed9366><</span><span> newsz</span><span style=color:#61676ccc>;</span><span> a </span><span style=color:#ed9366>+=</span><span> PGSIZE){
</span><span>    mem </span><span style=color:#ed9366>= </span><span style=color:#f29718>kalloc</span><span>()</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>(mem </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>){
</span><span>      </span><span style=color:#fa6e32>goto</span><span> error</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>    </span><span style=color:#f07171>memset</span><span>(mem</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> PGSIZE)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>mappages</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> a</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X</span><span style=color:#ed9366>|</span><span>PTE_R</span><span style=color:#ed9366>|</span><span>PTE_U) </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0</span><span style=color:#ed9366>||
</span><span>       </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> a</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> PTE_W</span><span style=color:#ed9366>|</span><span>PTE_X</span><span style=color:#ed9366>|</span><span>PTE_R)){
</span><span>      </span><span style=color:#f29718>kfree</span><span>(mem)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#399ee6>error</span><span style=color:#61676ccc>:
</span><span>      </span><span style=color:#f29718>uvmdealloc</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> a</span><span style=color:#61676ccc>,</span><span> oldsz)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#f29718>uvmdealloc_nofree</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> a</span><span style=color:#61676ccc>,</span><span> oldsz)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#fa6e32>return</span><span> newsz</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>嗯，但是我们可能要<code>fork</code>对吧？这时候就也要把自己的内核页表<code>fork</code>过去啦！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>int
</span><span style=color:#f29718>uvmcopy</span><span>(pagetable_t </span><span style=color:#ff8f40>old</span><span style=color:#61676ccc>,</span><span> pagetable_t </span><span style=color:#ff8f40>new</span><span style=color:#61676ccc>,</span><span> pagetable_t </span><span style=color:#ff8f40>kpagetable</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>sz</span><span>)
</span><span>{
</span><span>  pte_t </span><span style=color:#ed9366>*</span><span>pte</span><span style=color:#61676ccc>;
</span><span>  uint64 pa</span><span style=color:#61676ccc>,</span><span> i</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#55b4d4;font-style:italic>uint</span><span> flags</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>mem</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>for</span><span>(i </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366><</span><span> sz</span><span style=color:#61676ccc>;</span><span> i </span><span style=color:#ed9366>+=</span><span> PGSIZE){
</span><span>    </span><span style=color:#fa6e32>if</span><span>((pte </span><span style=color:#ed9366>= </span><span style=color:#f29718>walk</span><span>(old</span><span style=color:#61676ccc>,</span><span> i</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>      </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"uvmcopy: pte should exist"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>((</span><span style=color:#ed9366>*</span><span>pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>      </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"uvmcopy: page not present"</span><span>)</span><span style=color:#61676ccc>;
</span><span>    pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(</span><span style=color:#ed9366>*</span><span>pte)</span><span style=color:#61676ccc>;
</span><span>    flags </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE_FLAGS</span><span>(</span><span style=color:#ed9366>*</span><span>pte)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>((mem </span><span style=color:#ed9366>= </span><span style=color:#f29718>kalloc</span><span>()) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>      </span><span style=color:#fa6e32>goto</span><span> err</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f07171>memmove</span><span>(mem</span><span style=color:#61676ccc>, </span><span>(</span><span style=color:#fa6e32>char</span><span style=color:#ed9366>*</span><span>)pa</span><span style=color:#61676ccc>,</span><span> PGSIZE)</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>mappages</span><span>(new</span><span style=color:#61676ccc>,</span><span> i</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> flags) </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0 </span><span style=color:#ed9366>||
</span><span>       </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>,</span><span> i</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> flags </span><span style=color:#ed9366>& ~</span><span>PTE_U) </span><span style=color:#ed9366>!= </span><span style=color:#ff8f40>0</span><span>){
</span><span>      </span><span style=color:#f29718>kfree</span><span>(mem)</span><span style=color:#61676ccc>;
</span><span>      </span><span style=color:#fa6e32>goto</span><span> err</span><span style=color:#61676ccc>;
</span><span>    }
</span><span>  }
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span> </span><span style=color:#399ee6>err</span><span style=color:#61676ccc>:
</span><span>  </span><span style=color:#f29718>uvmunmap</span><span>(new</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> i </span><span style=color:#ed9366>/</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>uvmunmap</span><span>(kpagetable</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> i </span><span style=color:#ed9366>/</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>1</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><p>下一个，读者们用过<code>htop</code>吗？如果用过的话应该知道我们有个进程叫<code>init</code>吧？<code>pid 01</code>的那个。<br> 没错，XV6也有<code>init</code>进程，但是他的创建方法比较不一样，但是我们也得改！毕竟要改的全嘛！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#fa6e32>void
</span><span style=color:#f29718>uvminit</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>,</span><span> pagetable_t </span><span style=color:#ff8f40>kpagetable</span><span style=color:#61676ccc>,</span><span> uchar </span><span style=color:#ed9366>*</span><span style=color:#ff8f40>src</span><span style=color:#61676ccc>, </span><span style=color:#55b4d4;font-style:italic>uint </span><span style=color:#ff8f40>sz</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>char </span><span style=color:#ed9366>*</span><span>mem</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(sz </span><span style=color:#ed9366>>=</span><span> PGSIZE)
</span><span>    </span><span style=color:#f29718>panic</span><span>(</span><span style=color:#86b300>"inituvm: more than a page"</span><span>)</span><span style=color:#61676ccc>;
</span><span>  mem </span><span style=color:#ed9366>= </span><span style=color:#f29718>kalloc</span><span>()</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f07171>memset</span><span>(mem</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> PGSIZE)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>mappages</span><span>(pagetable</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> PTE_W</span><span style=color:#ed9366>|</span><span>PTE_R</span><span style=color:#ed9366>|</span><span>PTE_X</span><span style=color:#ed9366>|</span><span>PTE_U)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>mappages</span><span>(kpagetable</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)mem</span><span style=color:#61676ccc>,</span><span> PTE_W</span><span style=color:#ed9366>|</span><span>PTE_R</span><span style=color:#ed9366>|</span><span>PTE_X)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f07171>memmove</span><span>(mem</span><span style=color:#61676ccc>,</span><span> src</span><span style=color:#61676ccc>,</span><span> sz)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><blockquote><p>注：不要忘了<code>kpagetable</code>那里不可以有<code>PTE_U</code>哦！ヾ(•ω•`)o</blockquote><br><p>然后还有几个呢，就是我们有时候不是要扩容或缩小内存嘛？所以那部分代码我们也得改！<br> 这些属于小修小补，我就不怎么细说了！<br> 在<code>kernel/proc.c</code>修改：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// userinit
</span><span style=color:#f29718>uvminit</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> initcode</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>sizeof</span><span>(initcode))</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// growproc
</span><span style=color:#fa6e32>if</span><span>((sz </span><span style=color:#ed9366>= </span><span style=color:#f29718>uvmalloc</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> sz</span><span style=color:#61676ccc>,</span><span> sz </span><span style=color:#ed9366>+</span><span> n)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// fork
</span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>uvmcopy</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> np</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> np</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>sz) </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>0</span><span>)
</span></code></pre><p>下面这个比较重要，是要在我们缩小内存时同步：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>//growproc
</span><span style=color:#fa6e32>else if</span><span>(n </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>0</span><span>){
</span><span>  </span><span style=color:#55b4d4;font-style:italic>uint</span><span> sz2 </span><span style=color:#ed9366>=</span><span> sz</span><span style=color:#61676ccc>;
</span><span>  sz </span><span style=color:#ed9366>= </span><span style=color:#f29718>uvmdealloc</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable</span><span style=color:#61676ccc>,</span><span> sz</span><span style=color:#61676ccc>,</span><span> sz </span><span style=color:#ed9366>+</span><span> n)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#f29718>uvmdealloc_nofree</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>,</span><span> sz2</span><span style=color:#61676ccc>,</span><span> sz2 </span><span style=color:#ed9366>+</span><span> n)</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=xun-zhao><a aria-label="Anchor link for: xun-zhao" class=zola-anchor href=#xun-zhao>寻找</a></h3><p>XV6的<code>walk</code>有一些问题，就是它只能用来找用户的VA，所以我们要稍微改一下！<br> 就是删一个判断而已，很简单的！<br> 在<code>kernel/vm.c</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>kvmaddr</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>va</span><span>)
</span><span>{
</span><span>  pte_t </span><span style=color:#ed9366>*</span><span>pte</span><span style=color:#61676ccc>;
</span><span>  uint64 pa</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(va </span><span style=color:#ed9366>>=</span><span> MAXVA)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>
</span><span>  pte </span><span style=color:#ed9366>= </span><span style=color:#f29718>walk</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> va</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(pte </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>((</span><span style=color:#ed9366>*</span><span>pte </span><span style=color:#ed9366>&</span><span> PTE_V) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>;
</span><span>  pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>PTE2PA</span><span>(</span><span style=color:#ed9366>*</span><span>pte)</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>return</span><span> pa</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=shan-chu-bu-shan-chu><a aria-label="Anchor link for: shan-chu-bu-shan-chu" class=zola-anchor href=#shan-chu-bu-shan-chu>删除？不删除！</a></h3><p><code>uvmdealloc</code>也有一些问题，就是它默认会清理我们所指向的内存，但是内核页表当然不能这样做啦，不然一启动就直接把全局内核页表的扬了！o((>ω< ))o<br> 这个也超级简单的，把<code>1</code>变成<code>0</code>而已！<br> 在<code>kernel/vm.c</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>uvmdealloc_nofree</span><span>(pagetable_t </span><span style=color:#ff8f40>pagetable</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>oldsz</span><span style=color:#61676ccc>,</span><span> uint64 </span><span style=color:#ff8f40>newsz</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>if</span><span>(newsz </span><span style=color:#ed9366>>=</span><span> oldsz)
</span><span>    </span><span style=color:#fa6e32>return</span><span> oldsz</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>PGROUNDUP</span><span>(newsz) </span><span style=color:#ed9366>< </span><span style=color:#f29718>PGROUNDUP</span><span>(oldsz)){
</span><span>    </span><span style=color:#fa6e32>int</span><span> npages </span><span style=color:#ed9366>= </span><span>(</span><span style=color:#f29718>PGROUNDUP</span><span>(oldsz) </span><span style=color:#ed9366>- </span><span style=color:#f29718>PGROUNDUP</span><span>(newsz)) </span><span style=color:#ed9366>/</span><span> PGSIZE</span><span style=color:#61676ccc>;
</span><span>    </span><span style=color:#f29718>uvmunmap</span><span>(pagetable</span><span style=color:#61676ccc>, </span><span style=color:#f29718>PGROUNDUP</span><span>(newsz)</span><span style=color:#61676ccc>,</span><span> npages</span><span style=color:#61676ccc>, </span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>  }
</span><span>
</span><span>  </span><span style=color:#fa6e32>return</span><span> newsz</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=xian-zhi-sheng-chang><a aria-label="Anchor link for: xian-zhi-sheng-chang" class=zola-anchor href=#xian-zhi-sheng-chang>限制生长！</a></h3><p>现在的话，要给用户进程不能无限扩容了，不然他可能会覆盖到内核页表。<br> 那我们要怎么做呢？没错，就是找到内核页表最低的地方，也就是<code>PLIC</code>！<br> 然后就不让他长到那里！<br> 为什么不是<code>CLINT</code>呢？因为内核副本不映射呀！(。・∀・)ノ<p>修改<code>kernel/sysproc.c</code>：<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64
</span><span style=color:#f29718>sys_sbrk</span><span>(</span><span style=color:#fa6e32>void</span><span>)
</span><span>{
</span><span>  </span><span style=color:#fa6e32>int</span><span> addr</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>int</span><span> n</span><span style=color:#61676ccc>;
</span><span>
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>argint</span><span>(</span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>, </span><span style=color:#ed9366>&</span><span>n) </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  addr </span><span style=color:#ed9366>= </span><span style=color:#f29718>myproc</span><span>()</span><span style=color:#ed9366>-></span><span>sz</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>PGROUNDUP</span><span>(addr</span><span style=color:#ed9366>+</span><span>n) </span><span style=color:#ed9366>>=</span><span> PLIC)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>if</span><span>(</span><span style=color:#f29718>growproc</span><span>(n) </span><span style=color:#ed9366>< </span><span style=color:#ff8f40>0</span><span>)
</span><span>    </span><span style=color:#fa6e32>return </span><span style=color:#ed9366>-</span><span style=color:#ff8f40>1</span><span style=color:#61676ccc>;
</span><span>  </span><span style=color:#fa6e32>return</span><span> addr</span><span style=color:#61676ccc>;
</span><span>}
</span></code></pre><h3 id=da-gai><a aria-label="Anchor link for: da-gai" class=zola-anchor href=#da-gai>大改！</a></h3><p>首先，我们要先创建一个新的内核页表。<br> 然后把内核栈给挪到新的内核页表！<br> 理论上，新旧页表应该都是能找到的，毕竟虚拟地址没变，物理地址也没变。<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>pagetable_t pagetable </span><span style=color:#ed9366>= </span><span style=color:#ff8f40>0</span><span style=color:#61676ccc>,</span><span> oldpagetable</span><span style=color:#61676ccc>;
</span><span style=color:#fa6e32>struct</span><span> proc </span><span style=color:#ed9366>*</span><span>p </span><span style=color:#ed9366>= </span><span style=color:#f29718>myproc</span><span>()</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 加这段
</span><span>pagetable_t old_kpagetable </span><span style=color:#ed9366>=</span><span> p</span><span style=color:#ed9366>-></span><span>kpagetable</span><span style=color:#61676ccc>;
</span><span>pagetable_t new_kpagetable </span><span style=color:#ed9366>= </span><span style=color:#f29718>kvmmake</span><span>(</span><span style=color:#ff8f40>0</span><span>)</span><span style=color:#61676ccc>;
</span><span>uint64 kstack_pa </span><span style=color:#ed9366>= </span><span style=color:#f29718>kvmaddr</span><span>(old_kpagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>kstack)</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>mappages</span><span>(new_kpagetable</span><span style=color:#61676ccc>,</span><span> p</span><span style=color:#ed9366>-></span><span>kstack</span><span style=color:#61676ccc>,</span><span> PGSIZE</span><span style=color:#61676ccc>, </span><span>(uint64)kstack_pa</span><span style=color:#61676ccc>,</span><span> PTE_R</span><span style=color:#ed9366>|</span><span>PTE_W)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#f29718>begin_op</span><span>()</span><span style=color:#61676ccc>;
</span></code></pre><p>下面这些的话，就是同步而已，而且原型都变了，不改就肯定报错了呢！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64 sz1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 修改这行
</span><span style=color:#fa6e32>if</span><span>((sz1 </span><span style=color:#ed9366>= </span><span style=color:#f29718>uvmalloc</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> new_kpagetable</span><span style=color:#61676ccc>,</span><span> sz</span><span style=color:#61676ccc>,</span><span> ph</span><span style=color:#ed9366>.</span><span>vaddr </span><span style=color:#ed9366>+</span><span> ph</span><span style=color:#ed9366>.</span><span>memsz)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>  </span><span style=color:#fa6e32>goto</span><span> bad</span><span style=color:#61676ccc>;
</span></code></pre><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>uint64 sz1</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 这行也改！
</span><span style=color:#fa6e32>if</span><span>((sz1 </span><span style=color:#ed9366>= </span><span style=color:#f29718>uvmalloc</span><span>(pagetable</span><span style=color:#61676ccc>,</span><span> new_kpagetable</span><span style=color:#61676ccc>,</span><span> sz</span><span style=color:#61676ccc>,</span><span> sz </span><span style=color:#ed9366>+ </span><span style=color:#ff8f40>2</span><span style=color:#ed9366>*</span><span>PGSIZE)) </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>0</span><span>)
</span><span>  </span><span style=color:#fa6e32>goto</span><span> bad</span><span style=color:#61676ccc>;
</span></code></pre><p>之前的话，没有内核页表副本嘛，所以exec当然就不用切换到这里，但是现在我们有了，所以就得主动切换到内核页表副本！<pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>p</span><span style=color:#ed9366>-></span><span>trapframe</span><span style=color:#ed9366>-></span><span>sp </span><span style=color:#ed9366>=</span><span> sp</span><span style=color:#61676ccc>; </span><span style=color:#abb0b6;font-style:italic>// initial stack pointer
</span><span style=color:#f29718>proc_freepagetable</span><span>(oldpagetable</span><span style=color:#61676ccc>,</span><span> oldsz)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// 添加这段！
</span><span>p</span><span style=color:#ed9366>-></span><span>kpagetable </span><span style=color:#ed9366>=</span><span> new_kpagetable</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>w_satp</span><span>(</span><span style=color:#f29718>MAKE_SATP</span><span>(p</span><span style=color:#ed9366>-></span><span>kpagetable))</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>sfence_vma</span><span>()</span><span style=color:#61676ccc>;
</span><span style=color:#f29718>kvmfree</span><span>(old_kpagetable)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#fa6e32>if</span><span>(p</span><span style=color:#ed9366>-></span><span>pid </span><span style=color:#ed9366>== </span><span style=color:#ff8f40>1</span><span>)
</span><span>  </span><span style=color:#f29718>vmprint</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable)</span><span style=color:#61676ccc>;
</span></code></pre><h3 id=ng-zen-me-bao-cuo><a aria-label="Anchor link for: ng-zen-me-bao-cuo" class=zola-anchor href=#ng-zen-me-bao-cuo>嗯？怎么报错？</a></h3><p>报错了吗？那确实可能是我这笔记不够仔细呢，不过如果你好好跟着这个笔记走的话，是不太可能有什么大报错的，基本都是一些语法的报错，比如我们刚刚动了很多函数对吧，你只要去改一些参数就可以了，这些就当作是练习吧，不难的！<h3 id=wan-jie-sa-hua><a aria-label="Anchor link for: wan-jie-sa-hua" class=zola-anchor href=#wan-jie-sa-hua>完结撒花</a></h3><p>这个真的是最难的一个LAB了，是不是之一不知道，不过很难，博主用了至少一个月来理解页表呀！<br> 不过这LAB让我学到的东西也超级多的，可以说是最好的LAB了！<h2 id=chang-jian-yi-wen><a aria-label="Anchor link for: chang-jian-yi-wen" class=zola-anchor href=#chang-jian-yi-wen>常见疑问</a></h2><p>Q：这个实验之后，我们在内核态和用户态用的分别是什么页表呢？<br> A：我调试了下，在<code>usertrap</code>时，使用的是<code>kpagetable</code>。用户态理论上是<code>pagetable</code>，但是我调试不出。具体为什么我会说理论上是，主要是这两段代码：<br> <code>kernel/trampoline.S:88</code><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span>userret</span><span style=color:#ed9366>:
</span><span>  # </span><span style=color:#f29718>userret</span><span>(TRAPFRAME</span><span style=color:#61676ccc>,</span><span> pagetable)
</span><span>  # </span><span style=color:#fa6e32>switch</span><span> from kernel to user</span><span style=color:#ed9366>.
</span><span>  # </span><span style=color:#f29718>usertrapret</span><span>() calls here</span><span style=color:#ed9366>.
</span><span>  # a0</span><span style=color:#ed9366>:</span><span> TRAPFRAME</span><span style=color:#61676ccc>,</span><span> in user page table</span><span style=color:#ed9366>.
</span><span>  # a1</span><span style=color:#ed9366>:</span><span> user page table</span><span style=color:#61676ccc>, </span><span style=color:#fa6e32>for</span><span> satp</span><span style=color:#ed9366>.
</span><span>
</span><span>  # </span><span style=color:#fa6e32>switch</span><span> to the user page table</span><span style=color:#ed9366>.
</span><span>  csrw satp</span><span style=color:#61676ccc>,</span><span> a1
</span><span>  sfence</span><span style=color:#ed9366>.</span><span>vma zero</span><span style=color:#61676ccc>,</span><span> zero
</span></code></pre><p><code>kernel/trap.c:usertrapret</code><pre class=language-C data-lang=C style=color:#61676c;background-color:#fafafa><code class=language-C data-lang=C><span style=color:#abb0b6;font-style:italic>// tell trampoline.S the user page table to switch to.
</span><span>uint64 satp </span><span style=color:#ed9366>= </span><span style=color:#f29718>MAKE_SATP</span><span>(p</span><span style=color:#ed9366>-></span><span>pagetable)</span><span style=color:#61676ccc>;
</span><span>
</span><span style=color:#abb0b6;font-style:italic>// jump to trampoline.S at the top of memory, which 
</span><span style=color:#abb0b6;font-style:italic>// switches to the user page table, restores user registers,
</span><span style=color:#abb0b6;font-style:italic>// and switches to user mode with sret.
</span><span>uint64 fn </span><span style=color:#ed9366>=</span><span> TRAMPOLINE </span><span style=color:#ed9366>+ </span><span>(userret </span><span style=color:#ed9366>-</span><span> trampoline)</span><span style=color:#61676ccc>;
</span><span>((</span><span style=color:#fa6e32>void </span><span>(</span><span style=color:#ed9366>*</span><span>)(uint64</span><span style=color:#61676ccc>,</span><span>uint64))fn)(TRAPFRAME</span><span style=color:#61676ccc>,</span><span> satp)</span><span style=color:#61676ccc>;
</span></code></pre><p>Q：为什么蹦床会跳进<code>kpagetable</code>，而不是<code>kernel_pagetable</code>？<br> A：因为<code>trampoline</code>用的内核页表似乎是<code>scheduler</code>设置的内核页表。<p>最后编辑时间：2025/6/15</section></article></main><div class=giscus></div><script async crossorigin issue-term=pathname repo=YOUR_NAME/YOUR_REPO src=https://utteranc.es/client.js theme=github-light></script></div>